> 目標：以 **Squalr（Rust rewrite）** 為基礎，盡量把「掃描/結果表/改值/反組譯/記憶體檢視/Pointer Scan」的 **使用者體驗與功能集合** 拉到接近 **Cheat Engine**打造為一款能比擬商業程式的軟體。  

---

## 0) 交付原則（避免做了很多但仍不好用）

- **P0 = 可用性 / 不崩潰 / 不轉圈**：任何功能只要會卡死、永遠 loading、read 失敗直接 crash，都必須先解決。
- **CE Parity 以「行為」驗收**：不是把字樣改成 CE 就算完成，而是「流程一致」：
  - 掃描 → 結果能顯示 → 右鍵/雙擊能操作 → 改值與 freeze 穩定 → 能跳到 disassembler/memory viewer → pointer scan 有進度/結果。
- **所有 UI 行為都要有 fallback**：包含「空結果提示」「權限/不可讀提示」「操作被禁用原因」，避免使用者誤判是 bug。
- **避免把「設定」做成使用者自殘開關**：任何會把可掃頁面排光或導致 0 結果的選項，要有防呆與警告。

---

## 1) Milestones（按依賴順序）

- **M0：工程化與回復基線（Build/配置/回歸測試）**
- **M1：掃描核心可靠性（0 結果/轉圈/不可讀崩潰/性能）**
- **M2：資料型別與掃描語意對齊（CE 型別、String vs AOB、比較運算）**
- **M3：結果表 CE 化（顯示、快捷鍵、右鍵選單、Change Value 工作流）**
- **M4：工具視窗 CE 化（Disassembler / Memory Viewer / Docking 可重開）**
- **M5：Pointer Scan（CE 等級端到端：引擎→結果→UI）**
- **M6：進階 CE Parity（Address List、熱鍵、Hex View、AOB wildcard、導出/導入…）**

---

## M0 — 工程化與回復基線（Build/配置/回歸測試）

### M0.1 建置/封裝流程固定化（避免每次都被 installer 擋住）
- [x] **P0**：建立「只編譯主程式」的標準命令與文件  
  - `cargo build -p squalr --release`  
  - `cargo run -p squalr`
  - DoD：README/CONTRIBUTING 或 developer.md 明確寫出。
- [x] **P0**：處理 Windows 下 `squalr.exe Access is denied`（檔案被占用）  
  - DoD：build 腳本/指引提示「先關掉正在跑的 exe」，避免誤判成編譯錯誤。
- [x] **P1**：提供最小 smoke test 指令（啟動後自動列舉 process、啟動掃描頁面不 crash）

### M0.2 設定檔與 layout 的 migration 策略（防止「老使用者永遠看不到新功能」）
- [x] **P0**：docking/layout 設定缺 tab 時 **自動補齊**（尤其是新加的 Disassembler / Memory Viewer / Pointer Scanner）
- [x] **P1**：提供 UI 的「Reset Layout」與「清除 docking_settings.json」的清楚提示（不是要使用者猜）

### M0.3 CE 對照基準（驗收用）
- [x] **P0**：建立 `docs/ce-parity-checklist.md`  
  - 列出 CE 的基礎行為（Exact/Changed/Unchanged/Inc/Dec/Unknown initial、AOB、String、Change Value、Freeze、Disassemble、Pointer Scan）
  - 每一項都有：Squalr 現況、差距、驗收步驟。

---

## M1 — 掃描核心可靠性（0 結果 / 轉圈 / 不可讀崩潰 / 性能）

### M1.1 「掃描永遠 0」根因封堵（設定檔過度排除）
- [x] **P0**：載入 `memory_settings.json` 時做 **正規化/防呆**  
  - 若 excluded flags 組合造成「幾乎無可掃頁面」，自動回退到安全預設並寫回。
  - DoD：使用者即使勾錯，也不會變成永遠 0；UI 顯示警告/提示原因。
- [x] **P1**：UI 設定頁加上「會影響可掃頁數」的即時預估（例如顯示可掃 region count / bytes）

### M1.2 「結果一直轉圈」狀態機修正（同步 callback / guard 覆寫）
- [x] **P0**：統一修正 UI → engine command 的狀態更新模式  
  - 原則：送出 request 前釋放鎖（drop guard），並且 **無論成功/失敗/異常** 都要解除 loading。
- [x] **P0**：把同類問題一併掃掉（set value / freeze / pagination query）
- [ ] **P1**：加上「超時/取消」機制：UI 等待超過 N 秒顯示可取消與錯誤資訊（避免假死）

### M1.3 ReadProcessMemory / WriteProcessMemory 失敗不得崩潰
- [ ] **P0**：任何 read 失敗都必須：
  - 不 panic/unwrap
  - UI 顯示 `??` / `Unreadable`
  - Output/Log 記錄錯誤原因（權限、guard page、noaccess…）
- [ ] **P0**：Change Value 流程 read 失敗也不 crash（見 M3.4）
- [ ] **P1**：針對「受保護進程」顯示明確原因（不提供 bypass，只做錯誤呈現）

### M1.4 性能與 UI Not Responding（CE 掃描選項對齊 + 避免讀到 20GB+ / output 刷屏）
> **要修訂：**用這段「整段替換」你 tasktodo.md 目前的 `### M1.4 ...` 區塊

- [x] **P0**：New Scan 前估算 snapshot 大小；超過門檻自動降級成 **CE 風格掃描範圍策略**
  - 預設：`MEM_PRIVATE + MEM_IMAGE`，排除 `MEM_MAPPED`（可配置）
  - 預設：只掃 `Writable`（可配置）
- [x] **P0**：新增 CE 同款「Memory region types」選項（UI + 設定持久化）
  - `MEM_PRIVATE` ✅
  - `MEM_IMAGE` ✅
  - `MEM_MAPPED` ⛔（預設關閉；打開要顯示「slow」提示）
- [x] **P0**：新增「排除該應用以外 DLL（只掃主程式 image）」選項（UI + 設定持久化）
  - `Image modules:` `Main module only (default)` / `All modules` / `Selected modules…`
  - DoD：Main module only 時，**所有非 exe 的 DLL image pages** 都不會進入掃描列表
- [x] **P0**：列舉頁面時略過 `PAGE_NOACCESS / PAGE_GUARD`
- [x] **P0**：新增 CE 設定同款保護旗標排除（UI + 設定持久化）
  - `Don't scan memory protected with No Cache`（排除 `PAGE_NOCACHE`）
  - `Don't scan memory with Write Combine`（排除 `PAGE_WRITECOMBINE`）
- [ ] **P1**：新增 CE 同款效能選項（UI + 設定持久化）
  - `Size of scanbuffer (KB)`（預設 2048；影響速度）
  - `Thread priority`（Normal/AboveNormal/Highest；只影響掃描工作執行緒）
- [ ] **P1**：Fast Scan 對齊 CE（目前 Squalr 已有雛形，補齊成 CE 行為）
  - `Fast scan on by default`（設定）
  - `Alignment` / `Last Digits`（互斥模式）
- [ ] **P1**：Pause/Delay 行為（CE 同款）
  - `Pause while scanning`（預設可設定；若做不到 suspend，至少要有「降低掃描佔用」fallback）
  - `Repeat scan delay (ms)`（Next Scan 之間延遲；避免 UI 卡頓/目標程式瞬間被打爆）
- [ ] **P1**：Output 視窗改成 virtualized list / ring buffer（避免每幀渲染巨量文字）
- [ ] **P1**：掃描進度與取消（大掃描必須可中止；ESC/Cancel button）


**M1 驗收（必跑）**
- [ ] Notepad 測試：4 Bytes Exact Value → 有結果、spinner 會停  
- [ ] 故意對不可讀頁：不崩潰、值顯示 unreadable  
- [ ] 大進程：不讀爆 RAM、不會 UI 未回應（至少可取消）
- 大進程掃描不會讀爆 RAM（不再出現 20GB+ snapshot）
- `Main module only` 開啟時：掃描範圍不包含任何外部 DLL 的 image pages
- `PAGE_NOCACHE / PAGE_WRITECOMBINE` 排除選項生效且不影響一般進程掃描

---

## M2 — 資料型別與掃描語意對齊（CE 型別、String vs AOB、比較運算）

### M2.1 型別顯示完全改成 CE 命名
- [x] **P0**：下拉顯示（含 endian/unsigned 等必要變體）
  - Byte / 2 Bytes / 4 Bytes / 8 Bytes
  - Float / Double
  - String（UTF-8）
  - Array of Bytes（AOB）
- [ ] **P1**：UI 寬度與長字不重疊（下拉選單與欄位顯示）

### M2.2 String 與 AOB 分離（解析、掃描、顯示）
- [ ] **P0**：String 與 Array of Bytes 必須是兩個獨立 DataType / Scan path
- [ ] **P0**：AOB 輸入規格（先做 MVP）
  - 支援：空白/逗號分隔的 hex bytes（例 `48 8B 05 00 00 00 00`）
  - 不支援：`??` wildcard（先列為 M6）
- [ ] **P1**：String 顯示：UTF-8 正常顯示；非 UTF-8 fallback 用 Hex（避免顯示錯亂/崩潰）

### M2.3 Scan comparator 語意修正（避免把比較運算走錯 scanner）
- [ ] **P0**：修正 dispatch：NotEqual / GreaterThan / >0 等不能被強制走到只支援 Equal 的 byte-array 路徑
- [ ] **P0**：pattern 長度與讀值長度一致（避免越界/爆量/顯示錯）
- [ ] **P1**：浮點 tolerance（CE 的「Rounded」/「±」概念）— 若現階段沒有，列入 backlog 並明確 UI 呈現

**M2 驗收**
- [ ] 同一段記憶：String 搜 `ABC` 與 AOB 搜 `41 42 43` 都能命中  
- [ ] `NotEqual`/`>0` 不會全 0 / 行為合理

---

## M3 — 結果表 CE 化（顯示、快捷鍵、右鍵選單、Change Value）

### M3.1 結果 footer 與分頁（CE 風格）
- [x] **P1**：footer 顯示：`Found: N | Showing X–Y | ...`
- [ ] **P1**：結果分頁/虛擬化（大量結果不會卡 UI）
- [ ] **P1**：結果列顯示欄位對齊（Address / Value / Previous / Type）

### M3.2 快捷鍵（CE 基本操作）
- [x] **P1**：`Ctrl+A` 全選
- [x] **P1**：`Ctrl+C` 複製選取列（tab 分隔；至少含 Address + Value + Prev + Type）
- [ ] **P1**：`Ctrl+V` 貼上選取列
- [ ] **P1** .etc 可自行延伸

### M3.3 右鍵選單（CE 常用集合）
- [ ] **P1**：Copy Address / Copy Value / Copy Previous
- [ ] **P1**：Select All / Copy Selected
- [ ] **P1**：Freeze / Unfreeze
- [ ] **P1**：Add Selected to Address List（見 M6 Address List）
- [ ] **P1**：Delete（刪除 address list 項目或移除結果）
- [ ] **P1**：Disassemble Here（跳到 Disassembler）
- [ ] **P1**：View Memory Region（跳到 Memory Viewer 並高亮 region）

### M3.4 Change Value（CE 工作流：右鍵 + 雙擊 + 只改選取列）
- [x] **P0**：右鍵新增 `Change Value…`
- [x] **P0**：雙擊結果列直接開 Change Value 對話框（可選開關）
- [x] **P0**：寫入只作用於「選取列」（不得誤改整頁/整個結果集）
- [ ] **P0**：read 失敗不崩潰  
  - Dialog 顯示 `Current: ?? (unreadable)`，允許取消
  - write 失敗顯示錯誤，不 crash
- [ ] **P1**：改值後立即刷新顯示（含 prev value 更新策略）

**M3 驗收**
- [ ] 一次掃描後：能全選、複製、右鍵出現完整選單  
- [ ] 雙擊可改值；選取多列改值只影響選取列  
- [ ] 不可讀地址：開改值不崩潰

---

## M4 — 工具視窗 CE 化（Disassembler / Memory Viewer / Docking 可重開）

### M4.1 Docking：視窗關閉後必須能再打開（不需重啟）
- [ ] **P0**：Windows menu / Toolbar action：select tab 的同時要 `set_visible(true)`
- [ ] **P0**：對舊 layout 做 migration：缺 tab 自動補進（避免永久看不到）

### M4.2 Disassembler（可用、可跳轉、可從結果/region 進入）
- [ ] **P1**：放到右側 dock 欄位（與其他工具同欄位 tabs）
- [ ] **P0**：深色主題可讀性修正（文字/輸入框顏色使用 theme 前景色）
- [ ] **P1**：功能最小集合
  - Go to Address
  - 顯示 Module / Address / Bytes / 指令
  - Refresh
  - 從結果列 `Disassemble Here` 跳轉
- [ ] **P2**：CE 常用增量（M6 也可）
  - Copy instruction / Copy bytes / Find out what accesses/writes（若未做 debugger，先列 backlog）

### M4.2.1 Disassembler 顯示格式對齊 CE（列表排版 / bytes 欄 / module+offset / 跳轉）
> **要修訂：**把這段「插入」到 tasktodo.md 的 `M4.2 Disassembler` 底下（作為新增子段落）

- [ ] **P0**：反組譯列表欄位排版對齊 CE（固定欄寬）
  - `Address` 欄：顯示 `module+offset`（例如 `Game.exe+123456`），必要時 hover 顯示 absolute
  - `Bytes` 欄：固定寬度、兩位 hex + 空格分隔（不足以 `??` 補齊）
  - `Instruction` 欄：mnemonic + operands；可解析相對位址顯示目標（例如 `jmp Game.exe+...`）
- [ ] **P0**：不可讀 bytes 不崩潰
  - bytes 顯示 `??`；instruction 顯示 `db ??` 或 `unreadable`（二選一但要一致）
- [ ] **P1**：互動對齊 CE
  - 右鍵：Copy address / Copy bytes / Copy instruction
  - `Go to address` 支援貼入：absolute、`module+offset`
- [ ] **P1**：與掃描結果互跳
  - `Disassemble Here` 必須定位到該地址並高亮該行（若地址落在外部 DLL，仍能顯示，但預設 filter/標註清楚）


### M4.3 Memory Viewer（先做 Memory Regions，後續再做 Hex Dump）【保留原本 + 補齊 CE 對齊】
> **要修訂：**用這段「整段替換」你原本的 `### M4.3 Memory Viewer ...`，原本三個 bullet **全部保留**，並新增 CE 對齊項目。

- [ ] **P1**：Memory Regions 清單
  - Base / End / Size / Module(+offset)
  - Refresh、右鍵 Copy、右鍵 Disassemble Here
- [ ] **P1**：View Memory Region（從結果列跳轉）
  - 自動高亮包含 address 的 region
  - 清除會遮蔽的 filter、並自動捲到高亮項

- [ ] **P2**：Hex Viewer（CE 的 Memory View）【原本保留，並補齊對齊細節】
  - 顯示 hex + ASCII
  - Follow address、搜尋 bytes/string（可等 M6）


- [ ] **P0**：Hex Viewer 地址欄（每行起始 address / base address）**顏色對齊 CE：綠色**
  - DoD：深色/淺色主題皆可讀；顏色由 theme 提供（避免硬編碼）
- [ ] **P1**：Hex Viewer 新增 `Display Type` 下拉（使用者可選擇顯示/解讀型別）
  - Byte / 2 Bytes / 4 Bytes / 8 Bytes / Float / Double / String(UTF-8) / Array of Bytes
  - DoD：游標/選取位置會依 Display Type 顯示解讀值（例如底部狀態列：`Address | Type | Value`）
- [ ] **P1**：Go to Address 對齊 CE（Hex Viewer 工具列）
  - 支援：absolute（hex/dec）與 `module+offset`
  - `Enter`=Go；跳轉後高亮該行
- [ ] **P1**：不可讀區域不崩潰（Hex Viewer）
  - bytes 顯示 `??`
  - ASCII 顯示 `.`
  - tooltip：`Unreadable (PAGE_GUARD/NOACCESS/permission)`

**M4.3 DoD（新增部分的驗收點）**
- Address 欄綠色（theme 驅動）且兩種主題可讀
- Display Type 可切換並正確解讀選取位置的值
- 不可讀頁面不崩潰：bytes=??、ASCII='.'

---

## M5 — Pointer Scan（CE 等級端到端：引擎→結果→UI）

> 注意：Pointer Scan 不應只是「顯示 UI」，而是完整的掃描引擎 + 結果結構 + 分頁查詢 + 進度/取消事件。

### M5.1 Engine：Pointer Scan 核心流程
- [ ] **P0**：定義 Pointer Scan 任務模型
  - 參數：指標寬度(32/64)、max depth、max offset count、offset range、alignment、掃描範圍（heap/static/stack 可選）
  - 取消/超時
- [ ] **P0**：掃描 + 建鏈
  - 產生候選 pointers
  - 逐層擴展到 target address
  - 去重/裁剪（避免爆量）
- [ ] **P1**：結果壓縮/儲存（可分頁提取）
  - 結果欄位：base pointer（可含 module+offset）、offset chain、final address、可選 confidence/meta

### M5.2 IPC/API：結果查詢與進度事件
- [ ] **P0**：Pointer Scan 結果 API（list/count/page）
- [ ] **P0**：TrackableTask 進度 → Engine Event → UI（進度條、剩餘時間可選）
- [ ] **P1**：取消事件與 UI state（canceled / done / error）

### M5.3 UI：Pointer Scanner 視圖（避免空白）
- [ ] **P0**：基本狀態呈現
  - `No pointer scan results yet`（空結果提示）
  - scanning / canceled / done
- [ ] **P0**：參數面板 + Start/Stop
- [ ] **P1**：結果表
  - pointer expression（可複製）
  - 模組/基址、offsets、最終地址
  - 分頁/排序（至少能分頁）
- [ ] **P1**：從掃描結果右鍵 `Pointer Scan for this Address`（預填 target address）

**M5 驗收**
- [ ] Pointer Scanner tab 不空白  
- [ ] 能開始掃描、看到進度、可取消、能顯示結果  
- [ ] 從結果列觸發 pointer scan 預填地址可用

---

## M6 — 進階 CE Parity Backlog（完成 M1–M5 後逐項推）

### M6.1 Address List（CE 的下方表格：描述/凍結/熱鍵/群組）
- [ ] **P1**：新增 Address List 面板（可 dock）
  - 欄位：Description / Address / Type / Value / Active(freeze)
- [ ] **P1**：右鍵 `Add Selected to Address List`
- [ ] **P2**：群組/熱鍵/啟用停用、保存/載入 table

### M6.2 掃描模式對齊（CE 常用的 Next Scan 變化）
- [ ] **P1**：Unknown initial value
- [ ] **P1**：Changed / Unchanged
- [ ] **P1**：Increased / Decreased（含 by X）
- [ ] **P2**：Between、Value group、fuzzy scan（可選）

### M6.3 AOB wildcard 與 signature 工具
- [ ] **P2**：AOB 支援 `??` wildcard
- [ ] **P2**：Disassembler 產生 AOB signature（選指令範圍→copy AOB）

### M6.4 Memory View（Hex dump、Follow pointer、搜尋）
- [ ] **P2**：Hex Viewer（dump + ASCII）
- [ ] **P2**：Follow in dump / Follow in disassembler（互跳）
- [ ] **P2**：在 memory view 內搜尋 bytes/string

### M6.5 腳本/自動化（若 Squalr 目標包含）
- [ ] **P2**：Lua/JS/內建 scripting 的最小 API 對齊（掃描、改值、指標）
- [ ] **P3**：trainer/cheat table 類似輸出格式（若要對齊 CE 的 .CT 需另行設計）

---

## 7) 橫切品質要求（所有 milestone 都必須遵守）

- [ ] **錯誤處理一致**：read/write/scan 失敗 → UI 友善提示 + log，不 crash
- [ ] **可取消長任務**：Scan / Pointer Scan / 大量結果查詢
- [ ] **回歸測試**：每次改 scanner / UI 狀態機都要跑 M1 驗收三件套（Notepad、不可讀、長掃描可取消）
- [ ] **配置可復原**：Reset Layout / Reset Settings 要能回到「一定可掃描」狀態

---

## 8) 最小驗收腳本（貼在 PR 描述用）

> 每次提交至少跑下面 10 條，確保 CE 核心體驗沒退步。

- [ ] 選 Notepad → 4 Bytes Exact Value → 有結果、spinner 停止  
- [ ] Float/Double/8 Bytes → 不會全部 0  
- [ ] 結果 footer 顯示 Found/Showing  
- [ ] Ctrl+A / Ctrl+C 正常  
- [ ] 右鍵選單含 Change Value / Disassemble Here / View Memory Region / Pointer Scan for this Address  
- [ ] Change Value：只改選取列  
- [ ] 不可讀地址：不崩潰、顯示 unreadable  
- [ ] 關閉 Disassembler → 從選單再開，不需重啟  
- [ ] Memory Viewer：View Memory Region 會高亮並自動捲到  
- [ ] Pointer Scanner：不空白、有進度、有結果（或至少正確狀態提示）
